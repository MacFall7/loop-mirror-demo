<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loop Mirror - Emotional Intelligence for Music</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #ffffff;
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 40px 0;
    }

    .logo {
      font-size: 3rem;
      font-weight: bold;
      background: linear-gradient(45deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }

    .tagline {
      font-size: 1.2rem;
      color: #9ca3af;
      margin-bottom: 5px;
    }

    .powered-by {
      font-size: 0.9rem;
      color: #6b7280;
    }

    .upload-section {
      background: rgba(55, 65, 81, 0.5);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      margin-bottom: 30px;
      border: 2px dashed transparent;
      transition: all 0.3s ease;
    }

    .upload-section.dragover {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.1);
    }

    .upload-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      color: #3b82f6;
    }

    .upload-button {
      background: linear-gradient(45deg, #3b82f6, #8b5cf6);
      border: none;
      color: white;
      padding: 15px 30px;
      font-size: 1.1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .upload-button:hover {
      transform: translateY(-2px);
    }

    .upload-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .file-input {
      display: none;
    }

    /* üîÅ iOS-specific improvements (injected fix) */
    @media screen and (-webkit-min-device-pixel-ratio: 2) {
      .upload-button {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }

      .emotion-segment {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }
    }

    @media (max-width: 768px) {
      .upload-button {
        min-height: 44px;
        font-size: 1rem;
        padding: 15px 25px;
      }

      .emotion-segment {
        min-width: 44px;
        min-height: 44px;
      }

      .reset-button {
        min-height: 44px;
        font-size: 1rem;
      }

      .timeline {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .timeline::-webkit-scrollbar {
        display: none;
      }
    }

    input[type="file"] {
      -webkit-appearance: none;
      appearance: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo">Loop Mirror</div>
      <div class="tagline">Honest Emotional Feedback</div>
      <div class="powered-by">Powered by M87 Studio</div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section" id="uploadSection">
      <div class="upload-icon">üéµ</div>
      <h2>Upload Your Loop</h2>
      <p style="margin: 15px 0; color: #9ca3af;">Get visual emotional feedback in seconds</p>
      <button class="upload-button" id="uploadButton">
        <span>üìÅ</span>
        Choose Audio File
      </button>

      <!-- ‚úÖ UPDATED INPUT TAG -->
      <input type="file" 
             class="file-input" 
             id="fileInput" 
             accept="audio/mp3,audio/wav,audio/m4a,audio/aac,audio/flac,audio/ogg,audio/*,.mp3,.wav,.m4a,.aac,.flac,.ogg">

      <p style="margin-top: 15px; font-size: 0.9rem; color: #6b7280;">
        Supports MP3, WAV, M4A, FLAC
      </p>
      <p id="fileNameDisplay" style="margin-top: 10px; color: #ffffff;"></p>
    </div>

    <!-- Analyzing State -->
    <div class="analyzing" id="analyzingSection" style="display: none;">
      <div class="spinner"></div>
      <h3>Analyzing emotional content...</h3>
      <p style="color: #9ca3af; margin-top: 10px;">This may take a few seconds</p>
    </div>

    <!-- Results Section -->
    <div class="results-section" id="resultsSection">
      <!-- Timeline -->
      <div class="timeline-container">
        <div class="timeline-header">
          <div class="timeline-title">Emotional Journey</div>
          <div class="timeline-duration" id="timelineDuration">0:00 / 3:00</div>
        </div>
        <div class="timeline" id="timeline"></div>
      </div>

      <!-- AI Feedback -->
      <div class="feedback-section">
        <div class="feedback-header">
          <div class="feedback-title">AI Feedback</div>
          <div class="demo-badge">Demo Mode</div>
        </div>
        <div class="feedback-content" id="feedbackContent">
          Your feedback will appear here...
        </div>
      </div>

      <!-- Reset Button -->
      <div style="text-align: center;">
        <button class="reset-button" id="resetButton">Try Another Loop</button>
      </div>
    </div>
  </div>

  <!-- Modal for Emotion Details -->
  <div class="modal" id="emotionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Emotion Details</h2>
        <button class="close-button" id="closeModal">&times;</button>
      </div>
      <div id="modalBody">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>
<script>
  // Emotion color mapping
  const EMOTION_COLORS = {
    'Joy': '#fbbf24',
    'Sadness': '#3b82f6',
    'Anger': '#ef4444',
    'Fear': '#8b5cf6',
    'Surprise': '#f97316',
    'Disgust': '#10b981',
    'Contemplation': '#6366f1',
    'Melancholy': '#6b7280',
    'Building': '#f59e0b',
    'Release': '#ec4899',
    'Tension': '#dc2626',
    'Calm': '#22d3ee'
  };

  function getEmotionEmoji(emotion) {
    const emojis = {
      'Joy': 'üòä',
      'Sadness': 'üò¢',
      'Anger': 'üò†',
      'Fear': 'üò∞',
      'Surprise': 'üò≤',
      'Disgust': 'ü§¢',
      'Contemplation': 'ü§î',
      'Melancholy': 'üòî',
      'Building': 'üìà',
      'Release': 'üí•',
      'Tension': 'üò¨',
      'Calm': 'üòå'
    };
    return emojis[emotion] || 'üéµ';
  }

  function generateMockAnalysis(fileName) {
    const emotions = Object.keys(EMOTION_COLORS);
    const duration = 180;
    const segmentCount = 4 + Math.floor(Math.random() * 3);
    const segmentDuration = duration / segmentCount;

    let primaryEmotion = emotions[Math.floor(Math.random() * emotions.length)];
    if (fileName.toLowerCase().includes('sad')) primaryEmotion = 'Sadness';
    if (fileName.toLowerCase().includes('happy')) primaryEmotion = 'Joy';
    if (fileName.toLowerCase().includes('angry')) primaryEmotion = 'Anger';
    if (fileName.toLowerCase().includes('calm')) primaryEmotion = 'Calm';

    const segments = [];

    for (let i = 0; i < segmentCount; i++) {
      const startTime = i * segmentDuration;
      const endTime = Math.min((i + 1) * segmentDuration, duration);
      const related = {
        'Joy': ['Building', 'Release', 'Joy'],
        'Sadness': ['Melancholy', 'Contemplation', 'Calm'],
        'Anger': ['Tension', 'Building', 'Release'],
        'Calm': ['Contemplation', 'Melancholy', 'Joy']
      };
      const options = related[primaryEmotion] || emotions;
      const emotion = i === 0 ? primaryEmotion : options[Math.floor(Math.random() * options.length)];

      segments.push({
        id: `segment-${i}`,
        emotion,
        startTime,
        endTime,
        intensity: 0.4 + Math.random() * 0.5,
        duration: endTime - startTime
      });
    }

    return {
      segments,
      dominantEmotion: primaryEmotion,
      overallIntensity: 0.5 + Math.random() * 0.4,
      fileName
    };
  }

  function generateMockFeedback(analysis) {
    const templates = [
      `This loop establishes ${analysis.dominantEmotion.toLowerCase()} as its emotional foundation. The progression shows interesting dynamic development with ${analysis.segments.length} distinct emotional phases. The overall intensity (${Math.round(analysis.overallIntensity * 100)}%) suggests ${analysis.overallIntensity > 0.7 ? 'high energy engagement' : 'contemplative emotional space'}.`,
      `I'm hearing a ${analysis.dominantEmotion.toLowerCase()} core with ${analysis.segments.length === 4 ? 'clear' : 'complex'} emotional structure. This creates ${analysis.overallIntensity > 0.6 ? 'engaging' : 'introspective'} listening territory.`,
      `Your loop demonstrates ${analysis.dominantEmotion.toLowerCase()} effectively. The ${analysis.segments.length}-segment structure indicates ${analysis.segments.length > 4 ? 'nuanced' : 'direct'} emotional storytelling.`
    ];
    const suggestions = [
      "Consider adding dynamic contrast in transitional moments",
      "Experiment with harmonic modulation for emotional depth",
      "Try varying rhythmic density to enhance the emotional arc",
      "Build more tension into the middle section",
      "Explore counter-melodies to add complexity",
      "Consider subtle tempo variations for organic feel"
    ];
    const template = templates[Math.floor(Math.random() * templates.length)];
    const selected = suggestions.sort(() => 0.5 - Math.random()).slice(0, 2);
    return `${template}\n\nSuggestions:\n‚Ä¢ ${selected.join('\n‚Ä¢ ')}`;
  }

  function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
  }

  function createTimelineSegment(segment, totalDuration) {
    const width = Math.max(80, (segment.duration / totalDuration) * 800);
    const el = document.createElement('div');
    el.className = 'emotion-segment';
    el.style.width = `${width}px`;
    el.style.background = `linear-gradient(to top, ${EMOTION_COLORS[segment.emotion]}88, ${EMOTION_COLORS[segment.emotion]})`;
    el.style.borderColor = EMOTION_COLORS[segment.emotion];

    const label = document.createElement('div');
    label.className = 'emotion-label';
    label.textContent = segment.emotion;
    el.appendChild(label);

    el.addEventListener('click', () => showEmotionDetails(segment));
    return el;
  }

  function showEmotionDetails(segment) {
    const modal = document.getElementById('emotionModal');
    const modalBody = document.getElementById('modalBody');
    modalBody.innerHTML = `
      <div class="emotion-details">
        <div class="emotion-circle" style="background-color: ${EMOTION_COLORS[segment.emotion]};">
          ${getEmotionEmoji(segment.emotion)}
        </div>
        <div class="emotion-info">
          <h3>${segment.emotion}</h3>
          <p>Intensity: ${Math.round(segment.intensity * 100)}%</p>
        </div>
      </div>
      <div class="timing-details">
        <h4 style="margin-bottom: 15px;">Timing</h4>
        <div class="timing-row"><span>Start:</span><span>${formatTime(segment.startTime)}</span></div>
        <div class="timing-row"><span>End:</span><span>${formatTime(segment.endTime)}</span></div>
        <div class="timing-row"><span>Duration:</span><span>${formatTime(segment.duration)}</span></div>
      </div>`;
    modal.style.display = 'block';
  }

  document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('fileInput');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const uploadStatus = document.getElementById('uploadStatus');
    const uploadButton = document.getElementById('uploadButton');
    const uploadSection = document.getElementById('uploadSection');
    const analyzingSection = document.getElementById('analyzingSection');
    const resultsSection = document.getElementById('resultsSection');
    const resetButton = document.getElementById('resetButton');
    const modal = document.getElementById('emotionModal');
    const closeModal = document.getElementById('closeModal');

    const allowedTypes = [
      'audio/mp3', 'audio/mpeg', 'audio/wav', 'audio/x-wav',
      'audio/m4a', 'audio/aac', 'audio/flac', 'audio/ogg'
    ];
    const allowedExtensions = ['.mp3', '.wav', '.m4a', '.aac', '.flac', '.ogg'];

    uploadButton.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const name = file.name.toLowerCase();
      const type = file.type;
      const validType = allowedTypes.includes(type);
      const validExt = allowedExtensions.some(ext => name.endsWith(ext));

      if (!validType && !validExt) {
        uploadStatus.textContent = "‚ùå Unsupported file type.";
        uploadStatus.style.color = "red";
        fileInput.value = '';
        return;
      }

      if (file.size > 50 * 1024 * 1024) {
        uploadStatus.textContent = "‚ùå File exceeds 50MB limit.";
        uploadStatus.style.color = "red";
        fileInput.value = '';
        return;
      }

      fileNameDisplay.textContent = `Selected: ${file.name}`;
      uploadStatus.textContent = "‚úÖ Ready to upload";
      uploadStatus.style.color = "green";

      processAudioFile(file);
    });

    uploadSection.addEventListener('dragover', e => {
      e.preventDefault();
      uploadSection.classList.add('dragover');
    });

    uploadSection.addEventListener('dragleave', e => {
      e.preventDefault();
      uploadSection.classList.remove('dragover');
    });

    uploadSection.addEventListener('drop', e => {
      e.preventDefault();
      uploadSection.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('audio/')) {
        processAudioFile(file);
      }
    });

    resetButton.addEventListener('click', () => {
      uploadSection.style.display = 'block';
      analyzingSection.style.display = 'none';
      resultsSection.classList.remove('show');
      fileInput.value = '';
    });

    closeModal.addEventListener('click', () => modal.style.display = 'none');
    modal.addEventListener('click', e => {
      if (e.target === modal) modal.style.display = 'none';
    });

    function processAudioFile(file) {
      uploadSection.style.display = 'none';
      analyzingSection.style.display = 'block';

      setTimeout(() => {
        const analysis = generateMockAnalysis(file.name);
        const feedback = generateMockFeedback(analysis);
        displayResults(analysis, feedback);
      }, 2000 + Math.random() * 2000);
    }

    function displayResults(analysis, feedback) {
      analyzingSection.style.display = 'none';

      const timeline = document.getElementById('timeline');
      timeline.innerHTML = '';
      analysis.segments.forEach(segment => {
        const el = createTimelineSegment(segment, 180);
        timeline.appendChild(el);
      });

      document.getElementById('feedbackContent').textContent = feedback;
      resultsSection.classList.add('show');
    }
  });
</script>
</body>
</html>

